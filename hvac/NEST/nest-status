#!/usr/bin/php
<?php
include 'nest-config.php';

$infos = $nest->getDeviceInfo();
$infoLoc = $nest->getUserLocations();
$date = new DateTime();

function nesterror() {
	die();
}

set_error_handler("nesterror");

$active='I';
foreach ($infos->current_state as $state => $value) {
	switch ($state) {
		case 'mode': 	$modetmp=explode(',', $value);
				$mode=$modetmp[0];
				break;
		case 'ac': 	if ($value == 1) {
					$active = "C";
				}
				break;
		case 'heat':	if ($value == 1) {
					$active = "H";
				}
				break;
		case 'fan':	if ($value == 1) {
					if (($active == 'I') || ($active == 'V')) {
						$active = "F";
					}
				}
				break;
	}
}

//print_r($infos);
//echo "Mode: ".$mode."\n";
//echo "State: ".$active."\n";

$file='/tmp/hvac-status.ini';

//$contents="test=blah\nasdf=jkl\n";

if ($infos->target->mode == "range") {
	if ($mode == "cool") {
		$target_temp=$infos->target->temperature[1];
	} else {
		$target_temp=$infos->target->temperature[0];
	}
} else {
	$target_temp=$infos->target->temperature;
	if ($infos->target->mode == "off") {
		$mode="off";
	}
}

$contents="";
$contents="#AutoGenerated at ".$date->getTimestamp()."\n";
$contents.="current_temp=".$infos->current_state->temperature."\n";
$contents.="current_humidity=".$infos->current_state->humidity."\n";
$contents.="current_mode=".$mode."\n";
$contents.="current_active=".$active."\n";

//$contents.="target_temp=".$infos->target->temperature."\n";
$contents.="target_temp=".$target_temp."\n";
$contents.="away=".$infoLoc[0]->away."\n";
$contents.="ext_temp=".$infoLoc[0]->outside_temperature."\n";
$contents.="hum_enabled=".$infos->target->humidity_enabled."\n";
//$contents.="hrv=".exec('/usr/bin/sudo /usr/local/bin/ssrelay -r0')."\n";
$contents.="hrv=".exec('/usr/bin/sudo /usr/local/bin/hrvmode inistatus')."\n";

file_put_contents($file,$contents);
?>
